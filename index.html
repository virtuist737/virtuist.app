<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#009BFF">
    <meta name="description" content="Practice and study virtues to bring more peace and joy to your life">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Virtuist">
    <title>Virtuist</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <link rel="icon" href="assets/favicon.ico">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
</head>
<body>
    <div class="header">
        <div class="logo-container" style="cursor: pointer;" onclick="showVirtues()">
            <img src="assets/apple-touch-icon.png" width="75" height="75" alt="Virtuist logo">
            <h1 class="app-title">Virtuist</h1>
        </div>
        <button id="infoButton" class="info-button">i</button>
    </div>

    <div class="mode-selector" style="display: none;">
        <button class="mode-button active" onclick="switchMode('practice')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
            Practice
        </button>
        <button class="mode-button" onclick="switchMode('study')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
            Study
        </button>
    </div>

    <div id="selectedVirtueContainer" class="selected-virtue-container">
        <button class="back-arrow" onclick="showVirtues()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
        </button>
        <div id="selectedVirtue" class="selected-virtue"></div>
    </div>
    
    <div class="virtue-grid" id="virtueGrid"></div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>Created by <a href="https://tannerbraden.com">Tanner Braden</a> with the help of <a href="https://claude.ai">Claude</a></p>
        </br>
            <h2>About Virtuist</h2>
        </br>
            <h3>What are virtues?</h3>
        </br>
            <p>Virtues are universal behavioral instruments that elicit lasting peace and joy.</p>
        </br>
            <p>Just as musical instruments---like the piano---can elicit emotional experiences, virtues---like gratitude or empathy---are behavioral instruments that when wielded skillfully can elicit lasting emotional experiences of peace and/or joy in oneself and others.</p>
        </br>
            <h3>Why does this app exist?</h3>
        </br>
            <p>I'm building Virtuist in hopes that it will enable and inspire more individuals and families to practice virtues, thereby reducing suffering and increasing peace and joy.</p>
        </br>
            <p>I have observed that while both religious and secular organizations succeed at helping people practice some virtues, they fail to help with other virtues.</p>
        </br>
            <p>This app is my attempt to pave a better path that we can all walk together, helping each other practice virtues that will bring us all greater peace and joy.</p>
        </br>
            <h3>What are the plans for this app?</h3>
        </br>
            <p>My vision is to build an app similar to Duolingo, but instead of helping people study and practice their choice of foreign languages it will help them study and practice virtues.</p>
        </br>
            <p>I plan to first focus on the app itself, building it into a gamified experience with a robust library of resources.</p>
        </br>
            <p>Then I plan to try to enable Virtuists to connect with each other and build local communities on a common foundation of virtues.</p>
        </br>
            <h3>How can you help?</h3>
        </br>
            <ol>
                <li>Share Virtuist with your family and friends, inviting them to practice and study virtues with you.</li>
                <li>Email me at hello@virtuist.app to share your ideas for app features, practice exercises and example stories.</li>
                <li>Donate below so I can invest more time and money into building Virtuist. Every dollar helps and is greatly appreciated.</li>
            </ol>
        </br>
            <p>Thank you!</p>
            <div class="donation-container">
                <script async src="https://js.stripe.com/v3/buy-button.js"></script>
                <stripe-buy-button
                    buy-button-id="buy_btn_1QjWZdRw86YJu12Yh43fRmbu"
                    publishable-key="pk_live_51QjWB9Rw86YJu12YJnjfIDDhEkzmg8FCwnq0MI6kbC5fEviXQOVQlvGkgnqvpRV7mbhe8AzBwiFrAJdD2zVlKX4c002xSS1Wu8"
                >
                </stripe-buy-button>
            </div>
        </div>
    </div>

    <div class="content-container" id="practiceContainer">
        <div class="section">
            <div class="section-header">
                <div class="nav-arrows">
                    <button class="nav-arrow" onclick="previousPractice()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                    </button>
                    <button class="nav-arrow" onclick="nextPractice()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                </div>
                <h3>Exercise</h3>
            </div>
            <div class="section-content" id="practiceText"></div>
        </div>
    </div>

    <div class="content-container" id="studyContainer">
        <div class="section">
            <div class="section-header">
                <h3>Definition</h3>
            </div>
            <div class="section-content" id="studyDefinition"></div>
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="nav-arrows">
                    <button class="nav-arrow" onclick="previousStory()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                    </button>
                    <button class="nav-arrow" onclick="nextStory()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                </div>
                <h3>Example Story</h3>
            </div>
            <div class="section-content" id="studyStory"></div>
        </div>
    </div>

    <script>
        // Initialize variables
        let db;
        let virtues = [];
        let virtueColors = {};
        let virtuePractices = {};
        let virtueStories = {};
        let virtueDefinitions = {};
        let currentMode = 'practice';
        let currentVirtue = null;
        let currentPracticeIndex = 0;
        let currentStoryIndex = 0;

        // Initialize database and load data
        async function initDB() {
            try {
                const sqlPromise = initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                const dataPromise = fetch('virtuist.db').then(res => res.arrayBuffer());
                const [SQL, buf] = await Promise.all([sqlPromise, dataPromise]);
                return new SQL.Database(new Uint8Array(buf));
            } catch (error) {
                console.error('Error initializing database:', error);
                throw error;
            }
        }

        async function loadVirtuesData() {
            try {
                db = await initDB();
                
                // Load virtues and their properties
                const virtuesResult = db.exec(`
                    SELECT name, color, definition 
                    FROM virtues 
                    ORDER BY id
                `);
                
                if (virtuesResult[0] && virtuesResult[0].values) {
                    virtues = virtuesResult[0].values.map(row => row[0]);
                    virtueColors = Object.fromEntries(
                        virtuesResult[0].values.map(row => [row[0], row[1]])
                    );
                    virtueDefinitions = Object.fromEntries(
                        virtuesResult[0].values.map(row => [row[0], row[2]])
                    );
                }

                // Initialize the app
                initializeApp();
            } catch (error) {
                console.error('Error loading virtues data:', error);
            }
        }

        async function loadStoriesForVirtue(virtue) {
            try {
                const result = db.exec(`
                    SELECT content 
                    FROM stories 
                    WHERE virtue_id = (SELECT id FROM virtues WHERE name = '${virtue}')
                    ORDER BY id
                `);
                return result[0]?.values.map(row => row[0]) || [];
            } catch (error) {
                console.error('Error loading stories:', error);
                return [];
            }
        }

        async function loadPracticesForVirtue(virtue) {
            try {
                const result = db.exec(`
                    SELECT content 
                    FROM practices 
                    WHERE virtue_id = (SELECT id FROM virtues WHERE name = '${virtue}')
                    ORDER BY id
                `);
                return result[0]?.values.map(row => row[0]) || [];
            } catch (error) {
                console.error('Error loading practices:', error);
                return [];
            }
        }

        function initializeApp() {
            const virtueGrid = document.getElementById('virtueGrid');
            virtues.forEach(virtue => {
                const button = document.createElement('button');
                button.className = 'virtue-button';
                button.style.backgroundColor = virtueColors[virtue];
                button.onclick = () => selectVirtue(virtue);
                button.textContent = virtue.charAt(0).toUpperCase() + virtue.slice(1);
                virtueGrid.appendChild(button);
            });
        }

        async function selectVirtue(virtue) {
            currentVirtue = virtue;
            currentPracticeIndex = 0;
            currentStoryIndex = 0;
            
            // Load stories and practices for this virtue
            virtueStories[virtue] = await loadStoriesForVirtue(virtue);
            virtuePractices[virtue] = await loadPracticesForVirtue(virtue);
            
            document.documentElement.style.setProperty('--primary-color', virtueColors[virtue]);
            const selectedVirtueElement = document.getElementById('selectedVirtue');
            selectedVirtueElement.textContent = virtue.charAt(0).toUpperCase() + virtue.slice(1);
            document.getElementById('selectedVirtueContainer').style.display = 'block';
            document.querySelector('.mode-selector').style.display = 'flex';
            
            // Update active mode button and info button colors
            document.querySelector('.mode-button.active').style.backgroundColor = 'var(--primary-color)';
            document.getElementById('infoButton').style.backgroundColor = 'var(--primary-color)';
            
            showContent();
        }

        function switchMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = 'transparent';
            });
            
            event.currentTarget.classList.add('active');
            
            const activeButton = document.querySelector('.mode-button.active');
            activeButton.style.backgroundColor = currentVirtue ? 'var(--primary-color)' : '#383838';
            
            if (currentVirtue) {
                showContent();
            }
        }

        function showContent() {
            document.getElementById('virtueGrid').style.display = 'none';
            const practiceContainer = document.getElementById('practiceContainer');
            const studyContainer = document.getElementById('studyContainer');
            
            practiceContainer.style.display = currentMode === 'practice' ? 'block' : 'none';
            studyContainer.style.display = currentMode === 'study' ? 'block' : 'none';
            
            if (currentMode === 'practice') {
                showPractice();
            } else {
                showStudyContent();
            }
        }

        function showPractice() {
            const practiceArray = virtuePractices[currentVirtue];
            document.getElementById('practiceText').textContent = practiceArray[currentPracticeIndex];
        }

        function nextPractice() {
            const practiceArray = virtuePractices[currentVirtue];
            currentPracticeIndex = (currentPracticeIndex + 1) % practiceArray.length;
            showPractice();
        }

        function previousPractice() {
            const practiceArray = virtuePractices[currentVirtue];
            currentPracticeIndex = (currentPracticeIndex - 1 + practiceArray.length) % practiceArray.length;
            showPractice();
        }

        function showVirtues() {
            document.getElementById('virtueGrid').style.display = 'grid';
            document.getElementById('practiceContainer').style.display = 'none';
            document.getElementById('studyContainer').style.display = 'none';
            document.getElementById('selectedVirtueContainer').style.display = 'none';
            document.querySelector('.mode-selector').style.display = 'none';
            document.getElementById('infoButton').style.backgroundColor = '#383838';
        }

        function showStudyContent() {
            document.getElementById('studyDefinition').textContent = virtueDefinitions[currentVirtue];
            showStory();
        }

        function showStory() {
            const stories = virtueStories[currentVirtue];
            document.getElementById('studyStory').textContent = stories[currentStoryIndex];
        }

        function nextStory() {
            const stories = virtueStories[currentVirtue];
            currentStoryIndex = (currentStoryIndex + 1) % stories.length;
            showStory();
        }

        function previousStory() {
            const stories = virtueStories[currentVirtue];
            currentStoryIndex = (currentStoryIndex - 1 + stories.length) % stories.length;
            showStory();
        }

        // Modal handling
        const modal = document.getElementById("infoModal");
        const closeButton = document.getElementsByClassName("close")[0];

        document.getElementById("infoButton").onclick = function() {
            modal.style.display = "block";
        }

        closeButton.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Load data when page loads
        loadVirtuesData();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>